title: 架构演进 at ArchSummit2016
date: 2016-12-07 21:03:48
tags: architecture 

---

## 架构演进 at ArchSummit2016 

今天为大家介绍一下链家网的架构演进历史.

### 架构之痛

在 2014-2016 两年间，B 端用户由 3W 增加到 15 W, 网站点击数量由 80,000,000 提升到 1,600,000,000。 

从业务图的最上面可以看出来, 整个系统的交易链路很长
整个平台主要分为 2B、2C 两大块。

对于 C 端用户, 如果系统出了问题, 用户可能就会丢失.

对于 B 端用户, 他们是非常敏感的, 如果系统出了问题会直接影响到他们的绩效, 奖金.

所以系统的稳定性对于链家而言是很重要的概念. 链家之前也很重视这块, 所以和一些知名的厂商进行了很深入的合作. 什么叫深入呢? 

就是花了好几个亿, 订做了一整套完整的系统, 当时的系统非常的高大上. 支撑了过去很多年的业务发展.

C 端项目主要用 PHP 实现。
B 端项目主要用 Java 实现，运行在 商业 的 Websphere 容器中。
前端用 F5 做硬件负载。
B 端存储主要用 Oracle。 C 端存储主要用 MySQL

这么强大的一套系统, 运行的怎么样呢?

有时候很有规律, 每个月总有那么几天会挂掉;

有时候也不是那么有规律, 每次挂掉的原因都不一样.

- 有时候没法登陆
- 有时候登录了, 更可怕, 串号了
- 还有时候, 数据库发生了死锁
- 总之, 出现了各种各样奇葩的问题

当时在刚刚接手这套系统的时候, 就是在救火, 同事给我起的外号, 叫消防队长. 

当时的情况就是拿着消防队长的钱, 操着卖白粉的心. 一个不小心就可能被十几万经纪人在背后默默的慰问了无数次.

总结一下过去遇到的技术问题

#### 现有问题
- 可用性差：99%
- 性能差：单机 QPS 不到50, 去做横向扩展是没有什么意义的
- 强耦合: 两个多月都没搞清楚系统之剑 到底是什么样的关系
- 扩展性差、数据一致性差、容错能力差
- 可维护性差：上线难、迭代难
> QPS - req/sec 每秒请求服务器成功的次数, 通俗点说就是指, 服务器在一秒的时间内处理了多少个请求

链家网在成立的时候, 就已经背上了沉重的历史包袱. 怎么才能甩掉过去的历史包袱, 搭建起自己的系统? 

### 高可用架构的演进与实践

#### 会话层
过去的会话层
B端使用 Session 复制的方式
C端使用 Session 绑定的方式

这两种方案都有明显的缺陷, 所以会出现像 单机容量不足, 串号, 恢复困难的问题.

Session Replication: 
- 每台机器都要保存 整个 Session数据, 很多人同时访问会带来很大的内存占用
- Session 数据有任何变化, 就需要通知到其他所有机器, 机器集群数量越多, 所消耗的网络带宽资源就越大
Session Sticky:
- 如果Web 服务器重启, 会话会丢失.
- 负载服务器会保存 会话和具体服务器的映射,变成了一个有状态的节点, 在内存消耗和容灾上会更难处理

---

现在CMS的移动端登陆是怎么做的?