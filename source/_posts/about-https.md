title: About HTTPS!
date: 2017-05-16 07:50:22
tags: https,web

---

## EVENT

> 2010 年 5 月，谷歌开始提供 `HTTPS` 加密搜索服务。

> 2014 年 8 月，谷歌曾调整搜索引擎算法，并称「比起同等 `HTTP` 网站，采用 `HTTPS` 加密的网站在搜索结果中的排名将会更高」。

> 2014 年 9 月, 百度在一份公告中表示「百度不会主动抓取 `HTTPS` 网页」

> 2015 年 3 月, 百度启用全站 `HTTPS` 加密搜索服务

> 2016 年 9 月，微信宣布小程序要求使用 `HTTPS` 请求进行网络通信。

> 2016 年 9 月，百度曾就「`HTTPS` 站点如何建设才能对百度友好」问题发布了一篇文章，给出了「提高 `HTTPS` 站点的百度友好度」的四项建议及具体操作。

> 2016 年 10 月,苹果要求 `iOS` 设备发起的所有请求必须在 2017 年 1 月 1 号之前使用 `HTTPS`. (WebView 内的请求不在要求范围内)


众所周知，`HTTPS` 在效率上要比 `HTTP` 差、在部分搜索引擎上 `HTTPS` 也会对`SEO`也会造成一定的负面影响、站点要支持 `HTTPS` 也必然会付出不少的精力。

可既然有这么多的问题和成本在里面，那为什么这么多的大厂还在争先恐后的推动 `HTTPS` 的发展和建设呢？



<!— more —>




## WHAT

### HTTP (Hypertext Transfer Protocol)

`HTTP` 是在七层网络模型中的应用层的协议。

由客户端发送请求 `Request` 和 服务器端响应 `Response` 构成，是一个标准的 `Client` & `Server` 模型。

`HTTP` 是一个无状态的协议。

「无状态」，稍稍解释一下。自己在刚接触「无状态」的时候，一直很懵逼。
书上说，无状态是指把每个请求都作为与之前任何请求都无关的独立的事务。
通俗一点，就是说当你第二次访问服务器的时候，服务器并不知道你是谁。

可事实是，基于我们平时的使用习惯， 我们清楚的知道，服务器在你每次请求的时候，其实都知道你是谁。
这是因为浏览器和服务器之间已经基于 `HTTP` 无状态的特性，做了很多默认约定工作，用来保证请求的连续性。让本来无状态的 `HTTP` 协议，变得更加方便使用。

目前，为了保持客户端在服务器端的访问状态，被采用最多的实现方式就是 `Cookie` 了。与 `Cookie` 相对的一个解决方案是 `Session`，它是通过服务器来保持状态的。

这也就解释了，为什么我们在 `Chrome` 登录之后，在 `Safari` 依然需要重新登录。
因为不同浏览器之间的 `Cookie`，在默认情况下并不是共享的。
客户端的 `Cookie` 不同，客户端在服务器端的访问状态，服务器端自然也就无法识别了。

`HTTP` 协议运行在 `TCP` 协议之上，所有传输的内容都是明文。

### SSL (Secure Socket Layer)


### HTTPS (Hypertext Transfer Protocol Secure)

`HTTPS` 运行在 `SSL/TLS` 之上，`SSL/TLS` 运行在 `TCP` 之上，所有传输的内容都经过加密的。

`HTTPS` = `HTTP` + `SSL/TLS`

#### 明文

你想要给女神阿花写信。

你把想说的话，用英文写在信封里，因为一些原因，你不方便直接把信给阿花，只能把信封交给了女神家隔壁的老王，老王负责把你的信交给阿花。

这就是 `HTTP` 方式的信息传输。老王可以拆开查看信件内容，也可以直接修改里面的内容。

阿花给你的回复，也要先经过老王，老王依然可以拆开查看，然后修改内容，最后交给你。

整个过程没有安全性可言。

[^footnote]: 类比说明：你 = 客户端 / 浏览器、老王 = 在网络链路上的各种设备 如路由器、女神阿花 = 服务器

#### 对称加密

终于有一天，你和女神见面了，聊起来信的内容，你们发现纸条里面的内容被别人篡改过。

于是，你们想了一个办法，把纸条上的内容通过一串密码进行加密，密码和加密方式只有你们两个知道。

这样即使信在中途被别人拆开了，他也看不懂信的内容，他不知道规则，也无法伪造信的内容。

于是，你们终于可以安心的互通有无了。

这种方式就叫做「对称加密」，而你们加密所使用的密码就叫做「对称密钥」。

[^footnote]: `SSL` 使用`对称密钥 ` 对 `HTTP` 内容进行加/解密，让 `HTTP` 变得看起来安全了那么一些。

看起来，现在你和女神之间的通信已经可以高枕无忧了。真的是这样吗？

突然有一天，你想写信给住在老王另一个隔壁的老铁小杨，也需要通过老王来传递信件。（没错~ 隔壁老王就是这么神奇）

为了保证信件的安全，你还是需要用对称加密的方式。这就有会有几个问题：

1. 和阿花使用过的 「对称密钥」 已经不能再次使用，不然和女神之间的通信就会有安全风险，这也就意味着你必须用新的「密钥」对信件的内容进行加密； 
2. 你并不能直接见到小杨，那你们也就无法协商 「对称密钥」和 「加密方式」。想要建立安全的通信方式，只能在「明文」的信件内，把「对称秘钥」和「加密方式」告诉小杨。如果这份信刚好被老王拆掉看过，那你和小杨之间以后的任何通信依然没有安全性可言，只是增加了「中间人」老王以后的「攻击成本」。
3. 如果你要同时和很多人进行通信，就需要维护一份「通信人」与「对称密钥」的映射关系，并妥善保管。

[^footnote]: 看起来不太现实的场景，在互联网 の 世界里却随处可见。

如果对称加密这么麻烦，而且有这么多问题，那怎么办呢？

#### 非对称加密

这时候就需要用到江湖中流传已久的神功「非对称密钥」了。

「非对称加密」主要就是用来解决，如何把「对称密钥」







### HTTP 与 HTTPS

| -           | HTTP                              | HTTPS                                    |
| ----------- | --------------------------------- | ---------------------------------------- |
| Port        | 80                                | 443                                      |
| Artifacts   | -                                 | 需要到 `CA` 申请证书、构建支持 `HTTPS` 的服务器环境        |
| Charge      | Free                              | 按年收费，证书价格不等                              |
| Transfer    | 明文                                | 加密                                       |
| Performance | 直接运行在 `TCP` 协议之上, `TCP`  三次握手建立连接 | 在 `HTTP` (应用层) 协议和 `TCP` (传输层) 协议之间加入了 `SSL/TLS` 协议，用于加密传输的内容, 除了 `TCP` 三次握手，还需要加上 `SSL` 九次握手，还有 `SSL` 加/解密的 `CPU` 运行开销 |
| Secure      | 很容易被链路劫持, 盗取用户数据，篡改请求 / 响应内容      | 链路劫持的成本比较高，相对安全，但仍然无法防御 DNS 劫持           |
| SEO         | 支持良好                              | 不同浏览器支持情况不同。以国内目前的网络环境，在默认情况下，与比 `HTTP` 相比要差很多，不过这个问题可以通过额外的技术手段来处理，只是需要花费一些额外的成本 |

[^footnote]: `HTTP` / `HTTPS` 协议主要用于在客户端和服务器端之间做数据传输，这也就意味着 HTTPS 的安全性，只是针对本次连接中数据传输。这意味着如果你的计算机已经感染的了恶意软件，或者你已经被受到欺骗运行了某些恶意软件 — 这个世界上所有的HTTPS对于你而言也都无能为力了。

---

升级了 https 有什么好处吗？

https 有什么缺点吗？

使用了 https 就一定安全吗?
HTTPS 并非绝对安全，掌握根证书的机构、掌握加密算法的组织同样可以进行中间人形式的攻击。但HTTPS仍是现行架构下最安全的解决方案，并且它大幅增加了中间人攻击的成本。
对于不懂互联网的用户， 如果 Hacker 返回了一个伪造证书，用户信任了证书以后，中间人依然可以进行攻击。
12306 也是一个典型的案例。 证书本来就是自制的。

## WHY

为什么需要升级 https ?

国内网络环境很差，一些公共场所的路由器、小区的路由器很容易被黑客劫持。用户流量被劫持时，用户的相关信息对于 Hacker 而言，没有的安全可言。无论是窃取数据或者篡改用户数据。

国内运营商域名劫持植入广告太严重了。

网站在知名搜索引擎如 Google、百度上，还会对全站 https 的站点增加排名权重优先收录。 比如 


虽然百度曾表示“不会主动抓取https网页”，但对于“很多https网页无法被收录”也是“耿耿于怀”。
可见百度不主动抓取HTTPS站点也只是暂时的。



## HOW

### 如何搭建 / 迁移到 `https` 站点呢？

> 请自行相关查阅资料

这里介绍下目前公司内部关于 `https` 的使用

生产环境中，`CA` 签发的证书被配置在前端服务器 `nginx` 的集群上。

##### todo: 一张服务器架构的示意图片

#### 为什么不直接配置在应用服务器上呢？

服务器资源对于应用服务器而言，本身就是一种稀缺的资源。

如果在应用服务器上直接配置 `SSL` 证书，这就意味着所有客户端连接的建立、以及数据加解密的资源损耗，全部需要由应用服务器来承担，在连接较少的时候，可能影响还不大，如果连接多了起来，这无疑会压垮服务器，最后导致整个业务服务 Unavailable。

这就好像，你去参加马拉松，比赛开始又给自己加了 5 公斤的负重，刚开始跑，感觉还 OK，但跑得久了，就会发现自己根本无法承载这么高的负荷。很可能，在半路被抬到医院急救。「 No Zuo NO Die ~ 」



这里要稍微解释一下前端服务器 `nginx`，作为一款反向代理服务器。

它主要的作用是用来与客户端建立请求，并将请求转发到应用服务器，最后将应用服务器的响应返回给客户端。

作为客户端与服务器的「代理服务器」，它可以帮助我们处理一些简单的服务器负载均衡、请求的重写等等。

通过它起到的作用，我们大致可以发现，它对于服务器资源的使用其实并不多。

无需要复杂的数据运算、业务运算。

无需在内存中记录的业务数据，最多也只去存储一些页面缓存。

由于 `nginx` 支持异步非阻塞的网络 I/O 模型, 即使在高并发的情况下，它依然能保持低资源低消耗高性能。



所以，把 `SSL` 证书配置在前端服务器 `nginx` 上，再由 `nginx` 将 `https` 的请求以 `http` 协议的形式转发给应用服务器，无疑是资源最优化使用的方案。

而且，基于 `nginx` 本身的特性，我们还可以直接在 `nginx` 本身制定一些 `https` 的处理策略。比如：强制客户端 `http` 请求重定向到 `https`、如果发现请求来自于百度爬虫，把 `https` 请求重定向到 `http` 解决 `SEO` 的问题等。



如果客户端 `HTTPS` 连接过多，导致前端服务器 `nginx` `CPU` 资源耗尽，我们也只需扩展 `nginx` 集群即可。







[^footnote]: 「服务器资源：泛指服务器硬件资源，比如 `CPU`、内存等」、「应用服务器：泛指Web 业务应用」


## WHO

### 是否应该升级 `HTTPS` 呢?

虽然谷歌和百度都对 `HTTPS` 「另眼相看」，但这并不意味着我们都应该把网站协议转换成 `HTTPS`！

一般来说，如果网站类型属于电子商务、金融、社交网络等领域的话，采用 `HTTPS` 协议自然是更好的。

如果是个人博客、宣传类网站、资讯信息网站、或者是新闻网站之类的话，则可不必跟风而行，毕竟采用 `HTTPS` 协议不仅耗钱，浪费精力，而且在一定程度上，也不利于网站的 `SEO` 工作。



### todo: Thinks

CMS 资讯类型 不需要

商业站点，比如专题、会议。 支持 `HTTPS` 切换，满足商业用户的需求。

公开课 需要



## WHEN



什么时候做 `HTTPS` 好呢？





## FUTURE



### 除了 `HTTPS`, 我们还有什么可选的方案吗？







## todo: REFS



HTTPS可以有效的防止运营商劫持, 可以防止链路劫持，但无法防止 DNS 劫持
HTTP2

HTTPS 只是对你和服务器之间的流量进行了加密

HTTPS 确实需要更多的CPU来中断 SSL 连接 — 这需要的处理能力对于现代计算机而言是小菜一碟了.  你会遇到SSL性能瓶颈的可能性完全为0.

目前你更有可能在你的应用程序或者web服务器性能上遇到瓶颈.

