

Ajax 跨域资源共享（CORS）安全问题

\1. 跨域资源请求的方式：

- ajax在之前是要严格遵守同源策略的，但是在h5中为了提供更好的使用性，诞生了ajax跨域的方式-CORS。跨域资源共享是为了解决跨域请求的问题的。
- 除了CORS这个方案，还有另外两种跨域请求的方法，一个是使用jsonp的方式，一个是使用flash的跨域方案，通过服务器上的crossdomain.xml来控制跨域。

\2. CORS的做法：

CORS的跨域方式是通过：Access–Control-Allow-Origin这个头以及其他的头来实现的，客户端跨域访问一个服务器，服务器会确定这个这个域名是否有权限来获取资源，若有则返回一个带有Access–Control-Allow-Origin头的response以及资源。若无则返回一个权限错误：XMLHttpRequest cant load .....

\3. 风险点：

（1）. 对Access–Control-Allow-Origin设置为*,并且没有携带会话认证，这样子意味着信息被公开在全网。

（2）. http头可以伪造。http可以伪造意味着http头中的域名(origin)可以是假的，所以跨域是要配合身份验证进行的，所以跨域的时候记得带上session id。

（3）. 就算是使用了session id，但是第三方有可能也会被入侵，从而导致源站信息泄露，所以CORS是一个非常危险的东西。

（4）. 内部信息泄露，内部成员打开一个evil website，导致个人会话信息泄露，那么内部网站的数据将会泄露

（5）. 另外，不是设置了Access–Control-Allow-Origin，并且对请求站点做了权限控制，就可以防止信息泄露，在返回权限错误的时候，请求的信息其实已经到了客户端。

（6）. CORS默认不能携带会话信息，但是如果将withCredentials设置为true，则可以携带，所以这个属性最好设置为false。万一需要设置为true，请在Access–Control-Allow-Origin上设置具体的域名，不要使用 *。这是CORS的最后一层遮羞裤了，设置不好就裸奔了。

\4. 防御姿势：

- 不要对Access–Control-Allow-Origin使用 *
- 要对跨域请求验证session信息。
- 严格审查请求信息，比如请求参数，还有http头信息。

\5. 利用姿势：

CORS主要是提供了一种隐形的跨域数据传输方式，偷取信息用户是不能感受到的，主要是两种利用方式。

1. 第一个是需要将跨域js植入到被攻击的页面，这样子可以劫持到对方的cookie等认证信息。这种方式就是通过一个xss或者sqli，将js植入目标服务器，这样子就可以将认证信息偷过来了，如果是存储型就就更赞了，可以实时更新认证信息。
2. 第二个是将跨域放在自己控制的网站上，通过用户点击来攻击指定由CORS漏洞的服务器。这个要求目标服务器对CORS没有设置好，有CORS配置漏洞。
3. 另外ajax跨域不存在问题了，那么是不是CSRF也可以更隐蔽的进行了呢